"use strict";var Buffer=require("buffer").Buffer,Icnov=require("iconv-lite"),Base64Binary={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",decodeArrayBuffer:function(t){var e=t.length/4*3,n=new ArrayBuffer(e);return this.decode(t,n),n},removePaddingChars:function(t){return 64==this._keyStr.indexOf(t.charAt(t.length-1))?t.substring(0,t.length-1):t},decode:function(t,e){t=this.removePaddingChars(t),t=this.removePaddingChars(t);var n,r,a,g,l,i,s,I=parseInt(t.length/4*3,10),c=0,o=0;for(n=e?new Uint8Array(e):new Uint8Array(I),t=t.replace(/[^A-Za-z0-9\+\/\=]/g,""),c=0;c<I;c+=3)r=this._keyStr.indexOf(t.charAt(o++))<<2|(l=this._keyStr.indexOf(t.charAt(o++)))>>4,a=(15&l)<<4|(i=this._keyStr.indexOf(t.charAt(o++)))>>2,g=(3&i)<<6|(s=this._keyStr.indexOf(t.charAt(o++))),n[c]=r,64!=i&&(n[c+1]=a),64!=s&&(n[c+2]=g);return n}},WMFConverter=function(){this.executeTime=0};WMFConverter.prototype.log=function(t){},WMFConverter.prototype.downsizeCanvas=function(t,e){var n=document.createElement("canvas");return n.width=Math.floor(t.width*e),n.height=Math.floor(t.height*e),n.getContext("2d").drawImage(t,0,0,t.width,t.height,0,0,n.width,n.height),t=null,n},WMFConverter.prototype.toPNG=function(t){this.log("start convert");var e=t.split(",");t=e[e.length-1];var n=document.createElement("canvas");n.width=480,n.height=320,this.toCanvas(t,n),this.log("render canvas "+n.width+":"+n.height+":"+n.getAttribute("dpi"));var r=parseInt(n.getAttribute("dpi")),a=n.fontSize;if(isNaN(r)&&(r=1152),this.log("dpi canvas "+r),a<25)return this.log("end convert"),n.toDataURL();for(;a>24;)n=this.downsizeCanvas(n,.5),a/=2;return this.log("end convert"),n.toDataURL()},WMFConverter.prototype.toCanvas=function(t,e,n){let r=performance.now();function a(t){this.message=t,this.name="UserException"}function g(t,e){for(let n=0;n<t.length;n++)if(null===t[n]){t[n]=e;break}}function l(t,e,n,r,a,g,l,i,s,I,c){let o=new Image;o.src="data:image/bmp;base64,"+e,o.onload=function(){t.drawImage(o,n,r,a,g,l,i,s,I)},o.onerror=function(t){console.error("Img Onerror:",t)}}function i(t,e,n,r,a,g,l,i,s){let I=Math.abs(r-e)/2,c=Math.abs(a-n)/2;if(I<=0||c<=0)return;let o=Math.min(e,r)+I,f=Math.min(n,a)+c;if(t.beginPath(),g==i&&l==s)I==c?t.arc(o,f,I,0,2*Math.PI):t.ellipse(o,f,I,c,0,0,2*Math.PI);else{let e=Math.atan2((l-f)*I,(g-o)*c),n=I*Math.cos(e),r=c*Math.sin(e),a=Math.atan2((s-f)*I,(i-o)*c),h=I*Math.cos(a),b=c*Math.sin(a),u=Math.atan2((h-n)*-r-(b-r)*-n,(h-n)*-n+(b-r)*-r);t.ellipse(o,f,I,c,u,0,2*Math.PI)}t.stroke()}function s(t,e,n,r,a,g,l,i){if(void 0===i&&(i=!0),void 0===g&&(g=5),"number"==typeof g)g={tl:g,tr:g,br:g,bl:g};else{var s={tl:0,tr:0,br:0,bl:0};for(var I in s)g[I]=g[I]||s[I]}t.beginPath(),t.moveTo(e+g.tl,n),t.lineTo(e+r-g.tr,n),t.quadraticCurveTo(e+r,n,e+r,n+g.tr),t.lineTo(e+r,n+a-g.br),t.quadraticCurveTo(e+r,n+a,e+r-g.br,n+a),t.lineTo(e+g.bl,n+a),t.quadraticCurveTo(e,n+a,e,n+a-g.bl),t.lineTo(e,n+g.tl),t.quadraticCurveTo(e,n,e+g.tl,n),t.closePath(),l&&t.fill(),i&&t.stroke()}function I(t){return sprintf("#%06X",(255&t)<<16|(t>>8&255)<<8|t>>16&255)}function c(t){let e="";for(let n=0;n<t.byteLength;n++)e+=String.fromCharCode(t.getUint8(n));return window.btoa(e)}function o(t){let e=t.length,n=new DataView(new ArrayBuffer(e+14));n.setUint8(0,66),n.setUint8(1,77),n.setUint8(2,255&e),n.setUint8(3,e>>8&255),n.setUint8(4,e>>16&255),n.setUint8(5,e>>24&255),n.setUint8(6,0),n.setUint8(7,0),n.setUint8(8,0),n.setUint8(9,0);let r=(255&t[0])+((255&t[1])<<8)+((255&t[2])<<16)+((255&t[3])<<24)+14,a=(255&t[14])+((255&t[15])<<8),g=(255&t[32])+((255&t[33])<<8)+((255&t[34])<<16)+((255&t[35])<<24);switch(a){case 1:r+=8;break;case 4:r+=64;break;case 8:r+=1024;break;case 16:r+=0==g?0:262144;break;case 24:r+=0==g?0:67108864;break;case 32:r+=0==g?0:17179869184}n.setUint8(10,255&r),n.setUint8(11,r>>8&255),n.setUint8(12,r>>16&255),n.setUint8(13,r>>24&255);for(let r=0;r<e;r++)n.setUint8(14+r,t[r]);return n}function f(t){switch(t){case 0:case 2:return"CP1252";case 77:return"MacRoman";case 128:return"CP932";case 129:return"CP949";case 130:return"Johab";case 134:return"CP936";case 136:return"big5";case 161:return"CP1253";case 162:return"CP1254";case 163:return"CP1258";case 177:return"CP1255";case 178:return"CP1256";case 186:return"CP1257";case 204:return"CP1251";case 222:return"CP874";case 238:return"CP1250";case 255:default:return"CP1252"}}function h(t,e,n,r,a,g){return(e>=0?1:-1)*(r*t-(n+a))/g}function b(t,e,n,r,a,g){return(e>=0?1:-1)*(r*t-(n+a))/g}!function(t,e){e.width=480,e.height=320,e.fontSize=384;var n=e.getContext("2d");n.clearRect(0,0,e.width,e.height);let r=0,u=0,k=0,d=0,U=0,v=0,y=0,w=0,p=1,m=1,C=0,P="#000",A="evenodd",M=t.getUint32(r,!0);if(r+=4,2596720087==M){t.getInt16(r,!0);r+=2;t.getInt16(r,!0);r+=2;t.getInt16(r,!0);r+=2;t.getInt16(r,!0);r+=2;t.getInt16(r,!0);r+=2;let n=t.getUint16(r,!0);r+=2;t.getUint32(r,!0);r+=4;t.getUint16(r,!0);r+=2,k=t.getUint16(r,!0),r+=2,d=t.getUint16(r,!0),r+=2,e.setAttribute("dpi",n)}else k=65535&M,d=(4294901760&M)>>16;t.getUint16(r,!0);r+=2;t.getUint32(r,!0);r+=4;let T=t.getUint16(r,!0);r+=2;t.getUint32(r,!0);r+=4;t.getUint16(r,!0);if(r+=2,1!=k||9!=d)throw new a("Invalid file format.");let S=new Array(T);for(let t=0;t<T;t++)S[t]=null;let x=0,B=0;for(;;){let a=t.getUint32(r,!0)-3;r+=4;let k=t.getUint16(r,!0);if(r+=2,0==k)break;switch(u=r,k){case 53:break;case 55:var N=new(Array[t.getUint16(r,!0)]);r+=2;t.getUint16(r,!0);r+=2;t.getUint16(r,!0);r+=2;for(let e=0;e<N.length;e++)N[e]=t.getInt32(r,!0),r+=4;break;case 258:case 259:case 260:case 261:t.getInt16(r,!0);r+=2;break;case 262:{let e=t.getInt16(r,!0);r+=2,A=1==e?"evenodd":"nonzero";break}case 263:t.getInt16(r,!0);r+=2;break;case 264:t.getInt16(r,!0);r+=2;break;case 295:t.getInt16(r,!0);r+=2;break;case 313:t.getUint16(r,!0);r+=2;break;case 322:t.getInt32(r,!0);r+=4;new Int8Array(t.buffer,r,2*a-4);break;case 329:t.getUint32(r,!0);r+=4;break;case 513:{let e=t.getInt32(r,!0);r+=4,e=I(e),n.fillStyle=e;break}case 521:{let e=t.getInt32(r,!0);r+=4,e=I(e),P=e;break}case 529:t.getInt16(r,!0);r+=2;t.getInt16(r,!0);r+=2;break;case 531:{let e=t.getInt16(r,!0);r+=2;let a=t.getInt16(r,!0);r+=2,n.lineTo(a,e),n.stroke(),x=a,B=e;break}case 532:{let e=t.getInt16(r,!0);r+=2;let a=t.getInt16(r,!0);r+=2,n.beginPath(),n.moveTo(a,e),x=a,B=e;break}case 544:t.getInt16(r,!0);r+=2;t.getInt16(r,!0);r+=2;break;case 552:t.getUint16(r,!0);r+=2;t.getUint16(r,!0);r+=2;break;case 561:t.getUint32(r,!0);r+=4;break;case 564:t.getInt16(r,!0);r+=2;break;case 804:{let e=t.getInt16(r,!0);r+=2,n.beginPath();let a=h(t.getInt16(r,!0),y,U,1,0,p);r+=2;let g=b(t.getInt16(r,!0),w,v,1,0,m);r+=2,n.moveTo(a,g);for(let l=1;l<e;l++)a=h(t.getInt16(r,!0),y,U,1,0,p),r+=2,g=b(t.getInt16(r,!0),w,v,1,0,m),r+=2,n.lineTo(a,g);n.closePath(),n.fill(A),n.stroke();break}case 805:{let e=t.getInt16(r,!0);r+=2,n.beginPath();let a=h(t.getInt16(r,!0),y,U,1,0,p);r+=2;let g=b(t.getInt16(r,!0),w,v,1,0,m);r+=2,n.moveTo(a,g);for(let l=1;l<e;l++)a=h(t.getInt16(r,!0),y,U,1,0,p),r+=2,g=b(t.getInt16(r,!0),w,v,1,0,m),r+=2,n.lineTo(a,g);n.stroke();break}case 522:t.getInt16(r,!0);r+=2;t.getInt16(r,!0);r+=2;break;case 523:v=t.getInt16(r,!0),r+=2,U=t.getInt16(r,!0),r+=2;break;case 524:{let a=t.getInt16(r,!0);r+=2;let g=t.getInt16(r,!0);r+=2;let l=document.createElement("canvas"),i=l.getContext("2d");i.drawImage(e,0,0),e.width=Math.abs(g),e.height=Math.abs(a),n.drawImage(l,0,0),y=g,w=a;break}case 525:{let e=t.getInt16(r,!0);r+=2;let n=t.getInt16(r,!0);r+=2,vx=n,vy=e;break}case 526:t.getInt16(r,!0);r+=2;t.getInt16(r,!0);r+=2,vw=width,vh=height;break;case 527:{let e=t.getInt16(r,!0);r+=2;let n=t.getInt16(r,!0);r+=2,vox=n,voy=e;break}case 1040:{let e=t.getInt16(r,!0);r+=2;let n=t.getInt16(r,!0);r+=2;let a=t.getInt16(r,!0);r+=2;let g=t.getInt16(r,!0);r+=2,p=p*g/a,m=m*n/e;break}case 1042:t.getInt16(r,!0);r+=2;t.getInt16(r,!0);r+=2;t.getInt16(r,!0);r+=2;t.getInt16(r,!0);r+=2;break;case 1045:case 1046:t.getInt16(r,!0);r+=2;t.getInt16(r,!0);r+=2;t.getInt16(r,!0);r+=2;t.getInt16(r,!0);r+=2;break;case 1048:{let e=t.getInt16(r,!0);r+=2;let a=t.getInt16(r,!0);r+=2;let g=t.getInt16(r,!0);r+=2;let l=t.getInt16(r,!0);r+=2,n.beginPath(),n.ellipse(a,e,l,g,0,0,2*Math.PI),n.fill(),n.stroke();break}case 1049:{let e=t.getInt32(r,!0);r+=4;t.getInt16(r,!0);r+=2;t.getInt16(r,!0);r+=2,e=I(e);break}case 1065:t.getInt16(r,!0);r+=2;t.getInt16(r,!0);r+=2;t.getUint16(r,!0);r+=2;t.getUint16(r,!0);r+=2;break;case 1078:var N=new Array(t.getUint16(r,!0));r+=2;t.getUint16(r,!0);r+=2;t.getUint16(r,!0);r+=2;for(let e=0;e<N.length;e++)N[e]=t.getInt32(r,!0),r+=4;break;case 1313:break;case 1336:{let e=t.getInt16(r,!0);r+=2;let a=new Array(e);for(let n=0;n<e;n++)a[n]=t.getInt16(r,!0),r+=2;for(let g=0;g<e;g++){n.beginPath();let e=h(t.getInt16(r,!0),y,U,1,0,p);r+=2;let l=b(t.getInt16(r,!0),w,v,1,0,m);r+=2,n.moveTo(e,l);for(let i=1;i<a[g];i++)e=h(t.getInt16(r,!0),y,U,1,0,p),r+=2,l=b(t.getInt16(r,!0),w,v,1,0,m),r+=2,n.lineTo(e,l);n.closePath(),n.fill(A),n.stroke()}break}case 1352:{t.getUint16(r,!0);r+=2;let e=t.getInt32(r,!0);r+=4;t.getInt16(r,!0);r+=2;t.getInt16(r,!0);r+=2,e=I(e);break}case 1051:{let e=t.getInt16(r,!0);r+=2;let a=t.getInt16(r,!0);r+=2;let g=t.getInt16(r,!0);r+=2;let l=t.getInt16(r,!0);r+=2,n.rect(l,g,a-l,e-g),n.fill(),n.stroke();break}case 1055:{let e=t.getInt32(r,!0);r+=4;let a=t.getInt16(r,!0);r+=2;let g=t.getInt16(r,!0);r+=2,e=I(e),n.fillStyle=e,n.fillRect(g,a,1,1);break}case 1564:{let e=t.getInt16(r,!0);r+=2;let a=t.getInt16(r,!0);r+=2;let g=t.getInt16(r,!0);r+=2;let l=t.getInt16(r,!0);r+=2;let i=t.getInt16(r,!0);r+=2;let I=t.getInt16(r,!0);r+=2,s(n,I,i,l-I,g-i,(e+a)/2,!1,!0);break}case 1565:t.getUint32(r,!0);r+=4;t.getInt16(r,!0);r+=2;t.getInt16(r,!0);r+=2;t.getInt16(r,!0);r+=2;t.getInt16(r,!0);r+=2;break;case 30:break;case 2074:{let e=t.getInt16(r,!0);r+=2;let a=t.getInt16(r,!0);r+=2;let g=t.getInt16(r,!0);r+=2;let l=t.getInt16(r,!0);r+=2;let s=t.getInt16(r,!0);r+=2;let I=t.getInt16(r,!0);r+=2;let c=t.getInt16(r,!0);r+=2;let o=t.getInt16(r,!0);r+=2,i(n,o,c,I,s,l,g,a,e);break}case 2851:t.getUint32(r,!0);r+=4;t.getInt16(r,!0);r+=2;t.getInt16(r,!0);r+=2;t.getInt16(r,!0);r+=2;t.getInt16(r,!0);r+=2;t.getInt16(r,!0);r+=2;t.getInt16(r,!0);r+=2;t.getInt16(r,!0);r+=2;t.getInt16(r,!0);r+=2;new Int8Array(t.buffer,r,2*a-20);break;case 1574:break;case 298:t.getUint16(r,!0);r+=2;break;case 299:case 300:t.getUint16(r,!0);r+=2;break;case 301:{let a=t.getUint16(r,!0);r+=2;let g=S[a];switch(g.type){case"PEN":n.lineWidth=g.width,n.strokeStyle=g.color;break;case"BRUSH":n.fillStyle=g.color;break;case"FONT":n.font=sprintf("%s%d %dpx '%s'",g.italic?"italic ":"",g.weight,Math.abs(g.height),g.faceName),g.faceName.indexOf("Symbol")<0&&(e.fontSize=Math.abs(g.height)>e.fontSize?Math.abs(g.height):e.fontSize)}break}case 302:{let e=t.getInt16(r,!0);r+=2;let a=6&e,g=24&e;n.textAlign=2==a?"right":6==a?"center":"left",n.textBaseline=8==g?"bottom":0==g?"top":"alphabetic";break}case 2071:case 2096:t.getInt16(r,!0);r+=2;t.getInt16(r,!0);r+=2;t.getInt16(r,!0);r+=2;t.getInt16(r,!0);r+=2;t.getInt16(r,!0);r+=2;t.getInt16(r,!0);r+=2;t.getInt16(r,!0);r+=2;t.getInt16(r,!0);r+=2;break;case 2338:{let e=t.getUint32(r,!0);r+=4;let g=t.getInt16(r,!0);r+=2;let i=t.getInt16(r,!0);r+=2;let s=t.getInt16(r,!0);r+=2;let I=t.getInt16(r,!0);r+=2;let f=t.getInt16(r,!0);r+=2;let h=t.getInt16(r,!0);r+=2;let b=new Uint8Array(t.buffer,r,2*a-16),u=c(o(b));l(n,u,i,g,I,s,h,f,I,s,e);break}case 2610:{let e=a,g=b(t.getInt16(r,!0),w,v,1,0,m);r+=2;let l=h(t.getInt16(r,!0),y,U,1,0,p);r+=2,0==l&&(l=x),0==g&&(g=B);let i=t.getInt16(r,!0);r+=2;let s=t.getUint16(r,!0);r+=2,e-=4;let I=null;(6&s)>0&&((I=new Array(4))[0]=t.getInt16(r,!0),r+=2,I[1]=t.getInt16(r,!0),r+=2,I[2]=t.getInt16(r,!0),r+=2,I[3]=t.getInt16(r,!0),r+=2,e-=4);let c=new Buffer(i);for(let e=0;e<i;e++){let n=t.getInt8(r++,!0);c[e]=n}let o=Icnov.decode(c,C);if(1==i){let e=n.fillStyle;n.fillStyle=P,n.fillText(o,l,g),n.fillStyle=e;var E=t.getInt16(r,!0);r+=2}else{n.fillStyle;n.fillStyle=P,i%2==1&&t.getInt8(r++,!0);var E=0;for(let e=0;e<i;e++){n.fillText(o[e],l,g);var E=t.getInt16(r,!0);r+=2,E=h(E,y,U,1,0,p);var F=n.measureText(o[e]).width;l+=E=F>E?F:E}}break}case 3379:t.getUint16(r,!0);r+=2;t.getUint16(r,!0);r+=2;t.getUint16(r,!0);r+=2;t.getInt16(r,!0);r+=2;t.getInt16(r,!0);r+=2;t.getInt16(r,!0);r+=2;t.getInt16(r,!0);r+=2;t.getInt16(r,!0);r+=2;t.getInt16(r,!0);r+=2;break;case 2368:{let e=!1,g=t.getUint32(r,!0);r+=4;let i=t.getInt16(r,!0);r+=2;let s=t.getInt16(r,!0);r+=2;let I=t.getInt16(r,!0);r+=2,0==I&&(I=t.getInt16(r,!0),r+=2,e=!0);let f=t.getInt16(r,!0);r+=2;let h=t.getInt16(r,!0);r+=2;let b=t.getInt16(r,!0);if(r+=2,!e){let e=new Uint8Array(t.buffer,r,2*a-16),u=c(o(e));l(n,u,s,i,f,I,b,h,f,I,g)}break}case 2881:{let e=t.getUint32(r,!0);r+=4;let g=t.getInt16(r,!0);r+=2;let i=t.getInt16(r,!0);r+=2;let s=t.getInt16(r,!0);r+=2;let I=t.getInt16(r,!0);r+=2;let f=t.getInt16(r,!0);r+=2;let h=t.getInt16(r,!0);r+=2;let b=t.getInt16(r,!0);r+=2;let u=t.getInt16(r,!0);r+=2;let k=new Uint8Array(t.buffer,r,2*a-20),d=c(o(k));l(n,d,s,I,i,g,u,b,h,f,e);break}case 3907:{let e=t.getUint32(r,!0);r+=4;t.getUint16(r,!0);r+=2;let g=t.getInt16(r,!0);r+=2;let i=t.getInt16(r,!0);r+=2;let s=t.getInt16(r,!0);r+=2;let I=t.getInt16(r,!0);r+=2;let f=t.getInt16(r,!0);r+=2;let h=t.getInt16(r,!0);r+=2;let b=t.getInt16(r,!0);r+=2;let u=t.getInt16(r,!0);r+=2;let k=new Uint8Array(t.buffer,r,2*a-22),d=c(o(k));l(n,d,I,s,i,g,u,b,h,f,e);break}case 496:{let e=t.getUint16(r,!0);r+=2,S[e]=null;break}case 247:{t.getUint16(r,!0);r+=2;let e=new Array(t.getUint16(r,!0));r+=2;for(let n=0;n<e.length;n++)e[n]=t.getInt32(r,!0),r+=4;g(S,{type:"PALETTE",entries:e});break}case 505:{let e=new Int8Array(t.buffer,r,2*a);g(S,{type:"PATTERN_BRUSH",image:e});break}case 762:{let e=t.getUint16(r,!0);r+=2;let n=t.getInt16(r,!0);r+=2,t.getInt16(r,!0),r+=2;let a=I(t.getInt32(r,!0));r+=4,g(S,{type:"PEN",style:e,color:a,width:n});break}case 763:{let e=t.getInt16(r,!0);r+=2;let n=t.getInt16(r,!0);r+=2;let l=t.getInt16(r,!0);r+=2;let i=t.getInt16(r,!0);r+=2;let s=t.getInt16(r,!0);r+=2;let I=1==t.getInt8(r,!0);r++;let c=1==t.getInt8(r,!0);r++;let o=1==t.getInt8(r,!0);r++,C=t.getUint8(r,!0),r++;let h=t.getInt8(r,!0);r++;let b=t.getInt8(r,!0);r++;let u=t.getInt8(r,!0);r++;let k=t.getInt8(r,!0);r++;let d=2*a-18,U=new Buffer(d);for(let e=0;e<d;e++){let n=t.getInt8(r++,!0);if(0==n)break;U[e]=n}C=f(C);let v=Icnov.decode(U,C).replace(/\u0000/g,""),y={type:"FONT",faceName:v,height:e,width:n,escapement:l,orientation:i,weight:s,italic:I,underline:c,strikeout:o,charset:C,outPrecision:h,clipPrecision:b,quality:u,pitchAndFamily:k};g(S,y);break}case 764:{let e=t.getUint16(r,!0);r+=2;let n=I(t.getInt32(r,!0));r+=4;let a=t.getUint16(r,!0);r+=2,g(S,{type:"BRUSH",style:e,color:n,hatch:a});break}case 1791:{let e=t.getInt16(r,!0);r+=2;let n=t.getInt16(r,!0);r+=2;let a=t.getInt16(r,!0);r+=2;let l=t.getInt16(r,!0);r+=2,g(S,{type:"RECT_RGN",sx:l,sy:a,ex:n,ey:e});break}}r=u+2*a}}(new DataView(Base64Binary.decodeArrayBuffer(t)),e),this.executeTime=performance.now()-r,"function"==typeof n&&n(this)},WMFConverter.prototype.toPng=function(t){},WMFConverter.prototype.toSvg=function(t){},WMFConverter.prototype.getExeTime=function(){return this.executeTime};